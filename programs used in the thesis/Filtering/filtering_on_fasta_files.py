#!/usr/bin/env python3
"""
FASTA Sequence Filtering based on QC Results
============================================

Description:
    This script performs post-alignment filtering by reading the pass/fail status from a 
    previous quality control (QC) summary CSV and using that list of successful query IDs 
    to filter the original FASTA file. It is designed to extract "core" or high-confidence 
    sequences that meet all specified alignment criteria (e.g., minimum coverage, mismatch rate).

Key Features:
    1. Status Loading: Loads the full alignment summary CSV files (generated by a prior
       QC step) and extracts the set of `query_name`s where the `passed_both` status 
       is marked as "passed."
    2. FASTA Streaming Filter: Reads the large input FASTA files (25kb chunks) line-by-line 
       to efficiently filter sequences. This approach avoids loading the entire sequence data 
       into memory, ensuring scalability.
    3. Output Generation: Generates new, smaller FASTA files containing only the sequences 
       that successfully passed the complex alignment and coverage filtering criteria.

Parameters (User Inputs):
    FASTA_HAPIL (str), FASTA_FLORIDA (str): Paths to the original input FASTA files (25 kb chunks).
    CSV_HAPIL (str), CSV_FLORIDA (str): Paths to the QC summary CSV files containing the 
     pass/fail results for each query sequence.
    OUT_DIR (str): Directory where the final, filtered FASTA files will be saved.

Outputs:
    - Two Filtered FASTA Files: 'hapil_25kb_CORE_only.fasta' and 'florida_brilliance_25kb_CORE_only.fasta',
      containing only the query sequences that passed the alignment quality filters.
"""
import os
import pandas as pd

# ------------ Inputs ------------
# Query FASTAs (25 kb chunks)
FASTA_HAPIL = "/Users/michal/Desktop/pythonProject1_2/cut_genomes/hapil_20181217_consensus_25kb.fasta"
FASTA_FLORIDA = "/Users/michal/Desktop/pythonProject1_2/cut_genomes/florida_brilliance_25kb.fasta"

# Per-query CSV summaries (topN=all, min_cov=20, mismatch=30, total=80)
CSV_HAPIL = "/Users/michal/Desktop/pythonProject1_2/cut_genomes/alignments_with_cut_genomes/alignment_proper_cuts/filtered_alignments/filtered_alignments_min.coverage=20_mismatch=30%_topN=all/aln_hapil_to_red_gauntlet_25kb__coverage_summary_mismatch30.csv"
CSV_FLORIDA = "/Users/michal/Desktop/pythonProject1_2/cut_genomes/alignments_with_cut_genomes/alignment_proper_cuts/filtered_alignments/filtered_alignments_min.coverage=20_mismatch=30%_topN=all/aln_florida_to_royal_royce_25kb__coverage_summary_mismatch30.csv"

# Output directory
OUT_DIR = "/Users/michal/Desktop/pythonProject1_2/cut_genomes/alignments_with_cut_genomes/alignment_proper_cuts/filtered_alignments/filtered_fasta/filtered_fasta_25kb"
os.makedirs(OUT_DIR, exist_ok=True)
# --------------------------------

def load_passed_set(csv_path: str) -> set:
    """Read CSV and return set of query_name where passed_both == 'passed'."""
    df = pd.read_csv(csv_path)
    if "query_name" not in df.columns or "passed_both" not in df.columns:
        raise ValueError(f"CSV missing required columns in: {csv_path}")
    passed = set(df.loc[df["passed_both"].astype(str).str.lower() == "passed", "query_name"].astype(str))
    return passed

def filter_fasta_by_ids(in_fasta: str, keep_ids: set, out_fasta: str) -> None:
    """
    Stream FASTA and write only records whose header (first token after '>')
    is in keep_ids. Wraps sequence exactly as in input (line-by-line).
    """
    written = 0
    total = 0
    with open(in_fasta, "r") as fin, open(out_fasta, "w") as fout:
        keep = False
        for line in fin:
            if not line:
                continue
            if line.startswith(">"):
                total += 1
                header = line[1:].strip()
                qname = header.split()[0]  # first token is the query_name used in PAF/CSV
                keep = (qname in keep_ids)
                if keep:
                    fout.write(line)
                    written += 1
            else:
                if keep:
                    fout.write(line)
    print(f"[{os.path.basename(in_fasta)}] kept {written:,} of {total:,} sequences → {out_fasta}")

def main():
    # Hapil → Red Gauntlet
    hapil_pass = load_passed_set(CSV_HAPIL)
    out_hapil = os.path.join(OUT_DIR, "hapil_25kb_CORE_only.fasta")
    filter_fasta_by_ids(FASTA_HAPIL, hapil_pass, out_hapil)

    # Florida → Royal Royce
    florida_pass = load_passed_set(CSV_FLORIDA)
    out_florida = os.path.join(OUT_DIR, "florida_brilliance_25kb_CORE_only.fasta")
    filter_fasta_by_ids(FASTA_FLORIDA, florida_pass, out_florida)

if __name__ == "__main__":
    main()
